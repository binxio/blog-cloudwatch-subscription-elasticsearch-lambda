from lambdas.cloudwatch_subscription_lambda import *
import json

def event() -> dict:
    return {
    "awslogs": {"data": "H4sIAAAAAAAAAKVSXXPaMBD8Kx5PH1GQZNmS/AbFSchXKZA2kzjTEdZBPGMw9UdIyvDfe8ZJylObTp5s3+7d7Xpv6y6hLM0Cps9rcEN30Jv2flxGk0nvJHI7br5ZQYHlgHGhPM1FICmWs3xxUuT1GpGu2ZTdzCxn1nSTLK/txlTJAynrWZkU6bpK8xWBzJRVmpRgyLRIFwsojutVsofYcHxyxs5u5Oj8dfKkKsAscTSnTHUZ63LWvft00ZtGk+m9J40E61MFcyM8I1QiZAAQJB7XCozEEYerj9OsgqJ0wzv33+IKhODJLNcZkAP25+b1e/N6geIOW9loGHnSOxsMb0+v3fu9+ugRVlWzcOumFk14QlCfak0lo55kzOe+DDwZcBroQHhSUOEprZCklAi40AyxQCk0UqWYTYV63JD5gksptdZS8c5rZjh+G7uPaBDVxG7oxC6N3Q4+Utt+Btr6CnxDmA04SYApMrcyIVxQPTN85gkj2g4LlUkzUuEZtK2T5AFsnYF19pZaVpnXRfJCwOCPYO+2xUyS5HVD3C8+OJgWbty0WJMrYYxwNqV+yIOQs9uWU8DizQnUZIP2CXuF2t1lg97htmIVooKwVRC+scPDzWGBBv5+lgfxttGNsQXVfft6Or4Zj/rReT/GaN/+ULN+u9vFK3fX+VjE+p0RR1cDZww/ayQObehQP0Fv1BKwohEKiui5nhM1t3PLMFRr2MfVafpOdeNo9GU8/W+B1aAuTJMC8o884SzLuOqnWXNufxBGKQJOXF3CMi+enUn6C7DKlXPZx6J5cl6A6xJwMWf7emP+fvcbIoYHFtkEAAA="}}

def log_line() -> str:
    return "{\"version\": \"0\", \"id\": \"7fceb3f1-f0f7-3529-09dc-5b10edf9cb2b\", \"detail-type\": \"Scheduled Event\", \"source\": \"aws.events\", \"account\": \"612483924670\", \"time\": \"2018-11-21T05:24:21Z\", \"region\": \"eu-west-1\", \"resources\": [\"arn:aws:events:eu-west-1:612483924670:rule/cloudwatch-subscription-elast-CloudWatchEventsRule-11VQHRXRPBEKB\"], \"detail\": {}}\n"

def test_decode_event():
    assert decode_event(event()) == {'messageType': 'DATA_MESSAGE', 'owner': '612483924670', 'logGroup': '/aws/lambda/cloudwatch-subscription-elasticsea-TriggerFunction-1IRGJ1JX7PK70', 'logStream': '2018/11/21/[$LATEST]37a7ed508efa43a48c476ee6c3298ea7', 'subscriptionFilters': ['cloudwatch-subscription-elasticsearch-example-cloudwatch-CloudWatchLogSubscription-1PIE373JDIZHU'], 'logEvents': [{'id': '34405099071037115257637620696437404389840588462491762688', 'timestamp': 1542777999782, 'message': '{"version": "0", "id": "69d58e5a-1d62-ce18-fd7c-2409ba2b34a4", "detail-type": "Scheduled Event", "source": "aws.events", "account": "612483924670", "time": "2018-11-21T05:26:21Z", "region": "eu-west-1", "resources": ["arn:aws:events:eu-west-1:612483924670:rule/cloudwatch-subscription-elast-CloudWatchEventsRule-11VQHRXRPBEKB"], "detail": {}}\n'}, {'id': '34405099071037115257637620696437404389840588462491762689', 'timestamp': 1542777999782, 'message': 'END RequestId: 05c2460d-ed4e-11e8-9f9f-8fdfd1ba2da1\n'}, {'id': '34405099071037115257637620696437404389840588462491762690', 'timestamp': 1542777999782, 'message': 'REPORT RequestId: 05c2460d-ed4e-11e8-9f9f-8fdfd1ba2da1\tDuration: 0.34 ms\tBilled Duration: 100 ms \tMemory Size: 128 MB\tMax Memory Used: 21 MB\t\n'}]}

def test_load_log_line():
    assert json.loads(log_line()) == {'version': '0', 'id': '7fceb3f1-f0f7-3529-09dc-5b10edf9cb2b', 'detail-type': 'Scheduled Event', 'source': 'aws.events', 'account': '612483924670', 'time': '2018-11-21T05:24:21Z', 'region': 'eu-west-1', 'resources': ['arn:aws:events:eu-west-1:612483924670:rule/cloudwatch-subscription-elast-CloudWatchEventsRule-11VQHRXRPBEKB'], 'detail': {}}
